{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block title %}Adicionar Orçamento | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
.section { 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    border-radius: 8px; 
    padding: 16px; 
    margin-bottom: 16px; 
}
.section h2 { 
    margin: 0 0 12px 0; 
    font-size: 18px; 
    color: #1f2937;
}
.form-row { 
    margin-bottom: 12px; 
}
.label { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 6px; 
    color: #374151;
}
.input-field {
    width: 100%;
    max-width: 420px;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}
.input-field:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}
.amb-add { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
    margin-bottom: 12px; 
}
.amb-list { 
    border-top: 1px dashed #e5e7eb; 
    padding-top: 8px; 
    min-height: 40px;
}
.amb-item { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 8px 0; 
    border-bottom: 1px solid #f3f4f6;
}
.amb-item:last-child {
    border-bottom: none;
}
.btn { 
    cursor: pointer; 
    border: 0; 
    border-radius: 6px; 
    padding: 8px 12px; 
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}
.btn-primary { 
    background: #2563eb; 
    color: #fff; 
}
.btn-primary:hover {
    background: #1d4ed8;
}
.btn-danger { 
    background: #dc2626; 
    color: #fff; 
}
.btn-danger:hover {
    background: #b91c1c;
}
.btn-secondary {
    background: #6b7280;
    color: #fff;
}
.btn-secondary:hover {
    background: #4b5563;
}
.help { 
    color: #6b7280; 
    font-size: 12px; 
    margin-top: 4px;
}
.toolbar { 
    display: flex; 
    gap: 8px; 
    margin-top: 20px;
}
.errorlist {
    color: #dc2626;
    font-size: 12px;
    margin-top: 4px;
}
.empty-state {
    color: #9ca3af;
    font-style: italic;
    padding: 12px 0;
    text-align: center;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Home</a>
  › <a href="{% url 'admin:marcenaria_orcamento_changelist' %}">Orçamentos</a>
  › Adicionar
</div>
{% endblock %}

{% block content %}
<div id="content-main">
  <h1>Adicionar Orçamento</h1>

  <form method="post">
    {% csrf_token %}

    <div class="section">
      <h2>Informações Básicas</h2>
      
      <div class="form-row">
        <label class="label" for="cliente">Cliente *</label>
        <input type="text" 
               id="cliente" 
               name="cliente" 
               class="input-field" 
               value="{{ cliente|default:'' }}" 
               placeholder="Nome do cliente"
               required>
        {% if errors.cliente %}
          <div class="errorlist">{{ errors.cliente }}</div>
        {% endif %}
      </div>
      
      <div class="form-row">
        <label class="label" for="status">Status</label>
        <select id="status" name="status" class="input-field">
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if status == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
        {% if errors.status %}
          <div class="errorlist">{{ errors.status }}</div>
        {% endif %}
      </div>
    </div>

    <div class="section">
      <h2>Ambientes</h2>
      
      <div class="amb-add">
        <input type="text" 
               id="ambienteNome" 
               class="input-field" 
               placeholder="Nome do ambiente" 
               style="max-width: 300px;">
        <button type="button" class="btn btn-primary" id="btnAddAmbiente">
          Adicionar ambiente
        </button>
      </div>
      
      <div class="help">
        Adicione quantos ambientes quiser. Pressione Enter ou clique no botão para adicionar.
      </div>
      
      <div id="ambientesLista" class="amb-list">
        <div class="empty-state">Nenhum ambiente adicionado</div>
      </div>
      
      {% if errors.ambientes %}
        <div class="errorlist">{{ errors.ambientes }}</div>
      {% endif %}
    </div>

    <!-- Campo hidden para os ambientes em JSON -->
    <input type="hidden" 
           name="ambientes_json" 
           id="ambientesJson" 
           value="{{ ambientes_json|default:'[]' }}">

    <div class="submit-row toolbar">
      <button type="submit" class="btn btn-primary">
        Salvar Orçamento
      </button>
      <a class="btn btn-secondary" href="{{ changelist_url }}">
        Cancelar
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('ambienteNome');
  const btn = document.getElementById('btnAddAmbiente');
  const list = document.getElementById('ambientesLista');
  const hidden = document.getElementById('ambientesJson');

  if (!input || !btn || !list || !hidden) {
    console.error('Um ou mais elementos do formulário de ambientes não foram encontrados.');
    return;
  }

  let ambientes = [];
  try {
    ambientes = JSON.parse(hidden.value || '[]');
  } catch (e) {
    console.error('Erro ao carregar ambientes do campo hidden:', e);
    ambientes = [];
  }

  function render() {
    list.innerHTML = '';
    
    if (ambientes.length === 0) {
      list.innerHTML = '<div class="empty-state">Nenhum ambiente adicionado</div>';
    } else {
      ambientes.forEach((a, idx) => {
        const row = document.createElement('div');
        row.className = 'amb-item';
        row.innerHTML = `
          <span><strong>${a.nome}</strong></span>
          <button type="button" class="btn btn-danger" data-idx="${idx}" style="padding: 4px 8px; font-size: 12px;">
            Remover
          </button>
        `;
        list.appendChild(row);
      });
    }
    
    hidden.value = JSON.stringify(ambientes);
  }

  function addAmbiente() {
    const nome = input.value.trim();
    if (!nome) {
      input.focus();
      return;
    }
    
    const existe = ambientes.some(a => a.nome.toLowerCase() === nome.toLowerCase());
    if (existe) {
      alert('Este ambiente já foi adicionado!');
      input.focus();
      return;
    }
    
    ambientes.push({ nome });
    input.value = '';
    input.focus();
    render();
  }

  function removeAmbiente(idx) {
    ambientes.splice(idx, 1);
    render();
  }

  // --- Event Listeners ---
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    addAmbiente();
  });
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addAmbiente();
    }
  });

  list.addEventListener('click', (e) => {
    const btnRemove = e.target.closest('button[data-idx]');
    if (btnRemove) {
      const idx = parseInt(btnRemove.getAttribute('data-idx'), 10);
      if (confirm('Remover este ambiente?')) {
        removeAmbiente(idx);
      }
    }
  });

  // Renderizar estado inicial
  render();
  
  document.getElementById('cliente').focus();
});
</script>
{% endblock %}